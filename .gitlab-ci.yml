stages:
  - deploy
  - test

variables:
  DOCKER_IMAGE: devops-tools

before_script:
  - export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
  - export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
  - export AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION"
  - echo "VAULT_ADDR is $VAULT_ADDR"
  - echo "VAULT_TOKEN is $VAULT_TOKEN"
  - vault kv get -field=value secret/kubeconfig | base64 -d > kubeconfig
  - export KUBECONFIG=$(pwd)/kubeconfig
  - kubectl cluster-info

deploy:
  stage: deploy
  image: $DOCKER_IMAGE
  tags:
    - data-core
  script:
    - echo "Deploying Kubernetes resources..."
    - kubectl apply -f deployments/
    - echo "Waiting for deployments to be ready..."
    - kubectl wait --for=condition=available --timeout=300s deployment/mysql-deployment -n default || true
    - kubectl wait --for=condition=available --timeout=300s deployment/elasticsearch-deployment -n default || true
    - kubectl wait --for=condition=available --timeout=300s deployment/nginx-deployment -n default || true
    - echo "Waiting for pods to be ready..."
    - kubectl wait --for=condition=ready pod -l app=mysql --timeout=300s || true
    - kubectl wait --for=condition=ready pod -l app=elasticsearch --timeout=300s || true
    - kubectl wait --for=condition=ready pod -l app=nginx --timeout=300s || true
    - kubectl get pods
    - kubectl get services

test:
  stage: test
  image: $DOCKER_IMAGE
  tags:
    - data-core
  dependencies:
    - deploy
  script:
    - export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
    - export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
    - export AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION"
    - echo "VAULT_ADDR is $VAULT_ADDR"
    - echo "VAULT_TOKEN is $VAULT_TOKEN"
    - vault kv get -field=value secret/kubeconfig | base64 -d > kubeconfig
    - export KUBECONFIG=$(pwd)/kubeconfig
    - |
      # Get Kubernetes node IP for NodePort services
      NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}' || \
                kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}' || \
                echo "localhost")
      export KUBERNETES_NODE_IP=$NODE_IP
      echo "Kubernetes Node IP: $KUBERNETES_NODE_IP"
    - echo "Running tests..."
    - pytest tests/ -v --tb=short --junitxml=pytest-report.xml
  artifacts:
    when: always
    reports:
      junit: pytest-report.xml
    paths:
      - pytest-report.xml

